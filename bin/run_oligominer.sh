#!/bin/bash

set -euo pipefail


SPECIES=$1
TARGET_FASTA=$2

#Add entry number to fasta header to resolve duplicate headers
awk '/^>/{$0=$0"_target_"(++i)}1' "$TARGET_FASTA" > "$SPECIES"_temp.fa

seqkit split --by-id ./"$SPECIES"_temp.fa --out-dir "$SPECIES"_tmp

#For each .fa file inside the tmp directory, rename it to 1.fa, 2.fa,...
DIR="${SPECIES}_tmp"; EXT=fa; [ ! -r _e -a ! -r _c ] && echo "$EXT" > _e && echo 1 > _c && find "$DIR" -type f -name "*.$(cat _e)" -print0 | sort -z | xargs -0 -t -I{} bash -c 'mv -n "{}" "$(cat _c).$(cat _e)"; echo $(( $(cat _c) + 1 )) > _c' && rm -f _e _c

#Call script directly without python prefix (uses shebang + PATH):
for i in [0-9]*.fa; do
[ -e "$i" ] || break
blockParse.py \
--OverlapMode \
-l 25 -L 25 \
-g 44 -G 72 \
-t 48 -T 77 \
-s 165 \
-F 0 \
-f "$i"
done


#Caveat: these fastq files do not contain the final probe sequences. Instead, they are sense to the target region and need to be reverse complemented
#Format the headers of the fastq files generated by blockParse.py to have more informative names based on the target in the corresponding numbered fasta file
for f in *.fastq; do
  i="${f%%.*}"
  bash format_oligominer_fq_file.sh "$i"
done

#Convert the fastq files back to fasta files
for f in *.fastq; do i="${f%%.*}"; seqkit fq2fa "$i".fastq -o "$i"_blockparse.fasta ;done

cat *_blockparse.fasta > "${SPECIES}"_merged_blockparse.fa

#There are many redundant targets in merged_blockparse.fa. Collapse identical sequences before running BLAST.
cat "${SPECIES}"_merged_blockparse.fa | seqkit rmdup -s -o "${SPECIES}"_merged_blockparse_rmdup.fa
